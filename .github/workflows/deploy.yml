name: Deploy to Production Server

# Запускаем workflow при пуше в ветку 'main'
on:
  push:
    branches:
      - feature/CICD

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Шаг 1: Клонируем репозиторий, чтобы иметь доступ к docker-compose.yml и другим файлам,
      # если они понадобятся для сборки.
      - name: Checkout code
        uses: actions/checkout@v4

      # Шаг 2: Устанавливаем SSH-ключ для доступа к серверу
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_KEY }}
          name: id_rsa
          known_hosts: 'just-a-placeholder'

      # Шаг 3: Добавляем IP-адрес сервера в known_hosts для неинтерактивного подключения
      - name: Add server to known_hosts
        run: ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      # Шаг 4: Деплой на сервер по SSH
      - name: Deploy to Server
        run: |
          # Подключаемся к серверу и выполняем последовательность команд
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            # Переходим в папку для деплоя
            cd ${{ secrets.PROJECT_PATH }}

            echo ">>> 1. Pulling latest code from main branch..."
            # Убедимся, что мы на нужной ветке!
            git checkout feature/CICD 
            git pull origin feature/CICD

            echo ">>> 2. Creating .env.prod file from GitHub Secrets..."
            # Безопасно создаем файл с переменными окружения
            echo "${{ secrets.ENV_PROD_VARS }}" > .env.prod

            echo ">>> 3. Starting services with Docker Compose..."
            # Запускаем docker-compose. Он пересоздаст только измененные сервисы.
            # --build: пересобирает образ, если Dockerfile или код изменились.
            docker-compose up -d --build

            # Небольшая пауза, чтобы база данных успела полностью инициализироваться.
            echo ">>> Waiting 15 seconds for services to stabilize..."
            sleep 15

            echo ">>> 4. Applying database migrations..."
            # Замените 'web' на имя вашего сервиса с API, если оно другое (например, 'api')
            docker-compose exec web alembic upgrade head

            echo ">>> 5. Creating superuser (if not exists)..."
            docker-compose exec web python -m src/core/create_superuser.py

            echo ">>> 6. Cleaning up old Docker images..."
            docker image prune -f

            echo "✅ Deployment to ${{ secrets.SSH_HOST }} successful!"
